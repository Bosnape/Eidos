{% extends 'base.html' %}

{% block title %}Book Appointment - Eidos{% endblock %}

{% block extra_css %}
<style>
    body {
        padding-top: 64px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    input[type="date"],
    input[type="time"],
    select,
    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background-color: #f9fafb;
        font-size: 1rem;
        line-height: 1.5;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    input[type="date"]:focus,
    input[type="time"]:focus,
    select:focus,
    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 168, 150, 0.2);
    }

    label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .appointment-container {
        background-color: white;
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 460px;
        margin: 0 auto;
        padding: 1.75rem 1.25rem;
    }


    .btn-primary {
        background-color: var(--primary-color);
        color: white;
        transition: all 0.2s;
        border-radius: 0.375rem;
        font-weight: 500;
        padding: 0.5rem 1.25rem;
        border: none;
        cursor: pointer;
        text-align: center;
        font-size: 0.95rem;
    }

    .btn-primary:hover {
        background-color: var(--primary-dark);
    }

    h2 {
        font-size: 1.75rem;
        font-weight: 600;
        text-align: center;
        color: #1f2937;
        margin-bottom: 1.5rem;
    }

    main {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4rem 1rem;
        min-height: calc(100vh - 64px - 80px);
    }

    .form-navigation {
        display: flex;
        justify-content: space-between;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .form-navigation .btn-primary {
        width: auto;
        min-width: 100px;
        flex: 1;
        max-width: 150px;
    }
    .barber-gallery {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .barber-card {
        border: 2px solid transparent;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 120px;
    }

    .barber-card img.barber-photo {
        width: 100%;
        height: auto;
        border-radius: 50%;
        object-fit: cover;
    }

    .barber-card.selected {
        border-color: #007BFF;
        background-color: #e7f0ff;
    }
</style>
{% endblock %}

{% block content %}
<main>
    <div class="appointment-container">
        <h2>Book an Appointment at {{ business.name }}</h2>

        <form method="POST" id="appointment-form">
            {% csrf_token %}

            <!-- Step 1: Service Selection -->
            <div class="form-step" id="step-1">
                <div class="form-group">
                    <label for="id_service">Select a Service</label>
                    <select id="id_service" name="service" required>
                        {% for service in services %}
                            <option value="{{ service.id }}" data-price="{{ service.price }}">{{ service.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Service Price:</label>
                    <div id="price-display" class="form-input" style="background-color: #f3f4f6;">$0.00</div>
                    <input type="hidden" name="price" id="price-hidden" value="">
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn-primary" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 2: Barber Selection -->
            <div class="form-step" id="step-2" style="display: none;">
                <div class="form-group">
                    <label>Choose Your Barber</label>
                    <div id="barber-gallery" class="barber-gallery">
                        {% for barber in barbers %}
                            <div class="barber-card" data-id="{{ barber.id }}" onclick="selectBarber(this)">
                                <img src="{{ barber.photo.url }}" alt="{{ barber.name }}" class="barber-photo">
                                <p>{{ barber.name }}</p>
                            </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="barber" id="id_barber" required>
                </div>
                <div class="form-navigation">
                    <button type="button" class="btn-primary" onclick="prevStep()">‚Üê Back</button>
                    <button type="button" class="btn-primary" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 3: Date & Time -->
            <div class="form-step" id="step-3" style="display: none;">
                <div class="form-group">
                    <label for="date">
                        Select a Date
                        <span title="Choose the date you want your appointment." style="cursor: help;">üõà</span>
                    </label>
                    <input 
                        type="date" 
                        name="date" 
                        id="date" 
                        required 
                        placeholder="YYYY-MM-DD"
                        title="Choose the date you want your appointment."
                        oninvalid="this.setCustomValidity('Please select a valid date.')"
                        oninput="this.setCustomValidity('')"
                    >
                </div>

                <div class="form-group">
                    <label for="time">
                        Select a Time
                        <span title="Select the time that works best for your appointment." style="cursor: help;">üïí</span>
                    </label>
                    <input 
                        type="time" 
                        name="time" 
                        id="time" 
                        required 
                        placeholder="HH:MM"
                        title="Select the time that works best for your appointment."
                        oninvalid="this.setCustomValidity('Please select a valid time.')"
                        oninput="this.setCustomValidity('')"
                    >
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn-primary" onclick="prevStep()">‚Üê Back</button>
                    <button type="button" class="btn-primary" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 4: Payment method-->
            <div class="form-step" id="step-4" style="display: none;">
                <div class="form-group">
                    <label for="payment_method">Payment Method</label>
                    {{ form.payment_method }}
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn-primary" onclick="prevStep()">‚Üê Back</button>
                    <button type="button" class="btn-primary" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>

            <!-- Step 5: Confirmation -->
            <div class="form-step" id="step-5" style="display: none;">
                <h3>Confirm Your Appointment</h3>
                <p><strong>Service:</strong> <span id="confirm-service"></span></p>
                <p><strong>Barber:</strong> <span id="confirm-barber"></span></p>
                <p><strong>Date:</strong> <span id="confirm-date"></span></p>
                <p><strong>Time:</strong> <span id="confirm-time"></span></p>
                <p><strong>Price:</strong> <span id="confirm-price"></span></p>
                <p><strong>Payment:</strong> <span id="confirm-payment"></span></p>

                <div class="form-navigation">
                    <button type="button" class="btn-primary" onclick="prevStep()">‚Üê Back</button>
                    <button type="submit" class="btn-primary">Confirm ‚úì</button>
                </div>
            </div>
        </form>

        <!-- JS to manage step's flow -->
        <script>
            let currentStep = 1;

            function showStep(step) {
                document.querySelectorAll('.form-step').forEach((stepDiv, index) => {
                    stepDiv.style.display = (index === step - 1) ? 'block' : 'none';
                });
                currentStep = step;
                updateSummary();
            }

            function nextStep() {
                const currentDiv = document.querySelector(`#step-${currentStep}`);
                const requiredFields = currentDiv.querySelectorAll('select:required, input:required');

                // General validation of the required fields
                for (let field of requiredFields) {
                    if (!field.value) {
                        alert("Please complete all required fields before proceeding.");
                        return;
                    }
                }

                // Specific step 2 validation: barber selection
                if (currentStep === 2) {
                    const selectedBarber = document.getElementById('id_barber').value;
                    if (!selectedBarber) {
                        alert("Please select a barber before proceeding.");
                        return;
                    }
                }

                if (currentStep < 5) {
                    showStep(currentStep + 1);
                }
            }

            function prevStep() {
                if (currentStep > 1) {
                    showStep(currentStep - 1);
                }
            }

            // Service price
            const serviceSelect = document.getElementById('id_service');
            const priceDisplay = document.getElementById('price-display');
            const priceHidden = document.getElementById('price-hidden');

            serviceSelect.addEventListener('change', function () {
                const selectedOption = serviceSelect.selectedOptions[0];
                const price = selectedOption.getAttribute('data-price') || "0.00";
                priceDisplay.innerText = `$${price}`;
                priceHidden.value = price;
            });
            serviceSelect.dispatchEvent(new Event('change'));

            // Update final resume
            function updateSummary() {
                document.getElementById('confirm-service').textContent = serviceSelect.options[serviceSelect.selectedIndex].text;
                document.getElementById('confirm-price').textContent = priceDisplay.innerText;

                const selectedBarberCard = document.querySelector('.barber-card.selected');
                const barberText = selectedBarberCard ? selectedBarberCard.querySelector('p').textContent : '';
                document.getElementById('confirm-barber').textContent = barberText;

                document.getElementById('confirm-date').textContent = document.getElementById('date').value;
                document.getElementById('confirm-time').textContent = document.getElementById('time').value;

                const payment = document.getElementById('id_payment_method');
                const paymentText = payment ? payment.options[payment.selectedIndex].text : '';
                document.getElementById('confirm-payment').textContent = paymentText;
            }

            document.addEventListener("DOMContentLoaded", () => {
                showStep(1);
            });
        </script>
        <script>
            function selectBarber(element) {
                // Quitar selecci√≥n previa
                document.querySelectorAll('.barber-card').forEach(card => card.classList.remove('selected'));
            
                // Marcar la nueva selecci√≥n
                element.classList.add('selected');
            
                // Actualizar campo hidden con el ID del barbero
                const barberId = element.getAttribute('data-id');
                document.getElementById('id_barber').value = barberId;
            }
        </script>
    </div>
</main>
{% endblock %}

