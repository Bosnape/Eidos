{% extends 'base.html' %}

{% block title %}Manage Staff Availability - {{ business.name }}{% endblock %}

{% block extra_css %}
<style>
    body { 
        background-color: #f3f4f6;
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #374151;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .calendar-card {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .calendar-day {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
        background-color: white;
    }
    
    .calendar-day:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .calendar-day-today {
        background-color: rgba(59, 130, 246, 0.05);
        border-color: #3b82f6;
    }
    
    .calendar-day-unavailable {
        background-color: rgba(239, 68, 68, 0.05);
        border-color: #ef4444;
    }
    
    .shift-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        background-color: rgba(0, 168, 150, 0.1);
        color: var(--primary-color);
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
    }
    
    .availability-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
    }
    
    .availability-available {
        background-color: rgba(0, 168, 150, 0.1);
        color: var(--primary-color);
    }
    
    .availability-unavailable {
        background-color: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    
    .action-button {
        padding: 0.75rem 1.5rem;
        background-color: var(--primary-color);
        color: white;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: background-color 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .action-button:hover {
        background-color: var(--primary-dark);
    }
    
    .action-button-secondary {
        padding: 0.75rem 1.5rem;
        background-color: white;
        color: #6b7280;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .action-button-secondary:hover {
        background-color: #f9fafb;
        border-color: #9ca3af;
    }
    
    .form-select {
        display: block;
        width: 100%;
        padding: 0.5rem 2.5rem 0.5rem 0.75rem;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: all 0.2s;
    }
    
    .form-select:focus {
        outline: none;
        ring: 2px;
        ring-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .form-input {
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: all 0.2s;
    }
    
    .form-input:focus {
        outline: none;
        ring: 2px;
        ring-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .form-radio {
        width: 1rem;
        height: 1rem;
        color: var(--primary-color);
        border: 1px solid #d1d5db;
        border-radius: 50%;
        transition: all 0.2s;
    }
    
    .form-radio:focus {
        outline: none;
        ring: 2px;
        ring-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .employee-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .employee-avatar-placeholder {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-color: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
    }
    
    .modal-backdrop {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
    }
    
    .modal-content {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 28rem;
        margin: 0 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
        <a href="{% url 'schedule_list' %}" class="text-primary hover:text-primary-dark flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>Back to Schedules
        </a>
    </div>

    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <h1 class="section-title mb-0">Staff Availability</h1>
        
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
            <div>
                <label for="employee-select" class="block text-sm font-medium text-gray-700 mb-1">Select Employee</label>
                <select id="employee-select" class="form-select"
                        onchange="window.location.href='{% url 'manage_availability' %}' + (this.value ? this.value + '/' : '')">
                    {% for emp in employees %}
                        <option value="{{ emp.id }}" {% if emp.id == employee.id %}selected{% endif %}>
                            {{ emp.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="month-select" class="block text-sm font-medium text-gray-700 mb-1">Month</label>
                <select id="month-select" class="form-select">
                    <option value="2025-01">January 2025</option>
                    <option value="2025-02">February 2025</option>
                    <option value="2025-03" selected>March 2025</option>
                    <option value="2025-04">April 2025</option>
                    <option value="2025-05">May 2025</option>
                    <option value="2025-06">June 2025</option>
                </select>
            </div>
        </div>
    </div>

    <div class="calendar-card mb-8">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center">
                {% if employee.photo %}
                    <img class="employee-avatar mr-4" src="{{ employee.photo.url }}" alt="{{ employee.name }}">
                {% else %}
                    <div class="employee-avatar-placeholder mr-4">
                        <i class="fas fa-user"></i>
                    </div>
                {% endif %}
                <div>
                    <h2 class="text-xl font-bold text-gray-900">{{ employee.name }}</h2>
                    <p class="text-gray-600">{{ employee.job_description|truncatechars:60 }}</p>
                </div>
            </div>
        </div>

        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">{{ month_name }}</h3>
            
            <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                <div class="text-sm font-medium text-gray-500">Mon</div>
                <div class="text-sm font-medium text-gray-500">Tue</div>
                <div class="text-sm font-medium text-gray-500">Wed</div>
                <div class="text-sm font-medium text-gray-500">Thu</div>
                <div class="text-sm font-medium text-gray-500">Fri</div>
                <div class="text-sm font-medium text-gray-500">Sat</div>
                <div class="text-sm font-medium text-gray-500">Sun</div>
            </div>
            
            <div class="grid grid-cols-7 gap-1">
                {% for day in calendar_data %}
                    <div class="calendar-day p-2 h-32 overflow-y-auto 
                              {% if day.is_today %}calendar-day-today{% endif %} 
                              {% if day.availability and not day.availability.is_available %}calendar-day-unavailable{% endif %}">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium {% if day.is_today %}text-blue-600{% endif %}">
                                {{ day.date.day }}
                            </span>
                            <span class="text-xs text-gray-500">{{ day.day_name }}</span>
                        </div>
                        
                        {% if day.shifts %}
                            <div class="mb-2">
                                {% for shift in day.shifts %}
                                    <div class="shift-tag">
                                        {{ shift.start_time|time:"g:i A" }} - {{ shift.end_time|time:"g:i A" }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        {% if day.availability %}
                            {% if day.availability.is_available %}
                                <div class="availability-tag availability-available">Available</div>
                            {% else %}
                                <div class="availability-tag availability-unavailable">Unavailable</div>
                                {% if day.availability.reason %}
                                    <div class="text-xs text-gray-600 italic">{{ day.availability.reason }}</div>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        
                        <button type="button" 
                                class="mt-1 text-xs text-primary hover:text-primary-dark"
                                onclick="openAvailabilityModal('{{ day.date|date:'Y-m-d' }}', '{{ day.date|date:'l, F j, Y' }}', {% if day.availability %}{{ day.availability.is_available|lower }}{% else %}true{% endif %}, '{% if day.availability %}{{ day.availability.reason }}{% endif %}')">
                            {% if day.availability %}
                                Edit
                            {% else %}
                                Set
                            {% endif %}
                        </button>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Availability Modal -->
<div id="availability-modal" class="modal-backdrop hidden">
    <div class="modal-content">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900" id="modal-date-display">March 15, 2025</h3>
                <button type="button" onclick="closeAvailabilityModal()" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <form id="availability-form" method="post" class="p-6">
            {% csrf_token %}
            <input type="hidden" id="modal-date-input" name="date" value="">
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Availability Status</label>
                <div class="flex space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="is_available" value="true" checked class="form-radio">
                        <span class="ml-2 text-sm text-gray-700">Available</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="is_available" value="false" class="form-radio">
                        <span class="ml-2 text-sm text-gray-700">Unavailable</span>
                    </label>
                </div>
            </div>
            
            <div id="reason-container" class="mb-4 hidden">
                <label for="reason" class="block text-sm font-medium text-gray-700 mb-1">Reason (Optional)</label>
                <input type="text" id="reason" name="reason" class="form-input" placeholder="Vacation, sick day, etc.">
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeAvailabilityModal()" class="action-button-secondary">
                    Cancel
                </button>
                <button type="submit" class="action-button">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Show/hide reason field based on availability selection
        const availabilityRadios = document.querySelectorAll('input[name="is_available"]');
        const reasonContainer = document.getElementById('reason-container');
        
        availabilityRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'false') {
                    reasonContainer.classList.remove('hidden');
                } else {
                    reasonContainer.classList.add('hidden');
                }
            });
        });
    });
    
    function openAvailabilityModal(date, displayDate, isAvailable, reason) {
        // Set modal values
        document.getElementById('modal-date-display').textContent = displayDate;
        document.getElementById('modal-date-input').value = date;
        
        // Set availability radio buttons
        const availableRadio = document.querySelector('input[name="is_available"][value="true"]');
        const unavailableRadio = document.querySelector('input[name="is_available"][value="false"]');
        
        if (isAvailable) {
            availableRadio.checked = true;
            document.getElementById('reason-container').classList.add('hidden');
        } else {
            unavailableRadio.checked = true;
            document.getElementById('reason-container').classList.remove('hidden');
        }
        
        // Set reason if any
        document.getElementById('reason').value = reason || '';
        
        // Show modal
        document.getElementById('availability-modal').classList.remove('hidden');
    }
    
    function closeAvailabilityModal() {
        document.getElementById('availability-modal').classList.add('hidden');
    }
</script>
{% endblock %}
